# yaml-language-server: $schema=https://github.com/fluxcd-community/flux2-schemas/raw/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nextcloud
  namespace: vault
spec:
  interval: 30m
  chart:
    spec:
      chart: nextcloud
      version: 8.0.3
      sourceRef:
        kind: HelmRepository
        name: nextcloud
        namespace: flux-system
      interval: 30m
  dependsOn:
    - name: csi-driver-nfs
      namespace: storage
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  valuesFrom:
    - kind: Secret
      name: nextcloud-secret
      valuesKey: nextcloud-values.yaml
      optional: false
  values:
    image:
      repository: nextcloud
      tag: "32"
      pullPolicy: IfNotPresent
    externalDatabase:
      enabled: true
      type: postgresql
      host: postgres-pgbouncer.database.svc.cluster.local
      port: 5432
      database: nextcloud
      user: nextcloud
      sslmode: verify-ca
      ssl:
        enabled: true
        secretName: nextcloud-tls-ca-secret
        caCertKey: ca.crt
      existingSecret:
        enabled: true
        secretName: nextcloud-db-secret
        usernameKey: username
        passwordKey: password
    persistence:
      enabled: true
      existingClaim: nfs-data-pvc
      annotations: {}
      storageClass: ""
      accessMode: ReadWriteMany
      size: 1Gi
    nextcloud:
      host: nextcloud.${SECRET_DOMAIN}
      datadir: /var/www/html/data
      config:
        trusted_domains: nextcloud.${SECRET_DOMAIN}
        trusted_proxies: 10.69.0.0/16 10.96.0.0/16
        overwriteprotocol: https
        overwritehost: nextcloud.${SECRET_DOMAIN}
        memcache.local: \OC\Memcache\APCu
        memcache.distributed: \OC\Memcache\Redis
        memcache.locking: \OC\Memcache\Redis
        redis.host: nextcloud-redis-master  # Internal service name
        redis.port: 6379
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi
    cronjob:
      enabled: true
      # Runs every 5m by default
    ingress:
      enabled: true
      className: traefik-internal
      annotations:
        traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
        traefik.ingress.kubernetes.io/router.middlewares: "network-chain-no-auth@kubernetescrd,sticky@kubernetescrd"  # Sticky for HA scaling
      hosts:
        - host: nextcloud.${SECRET_DOMAIN}
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: "${SECRET_DOMAIN/./-}-production-tls"
          hosts:
            - nextcloud.${SECRET_DOMAIN}
    hpa:
      enabled: true
      minReplicas: 1
      maxReplicas: 3
      targetCPUUtilizationPercentage: 80  # Tuned higher for bursty media/file loads
      targetMemoryUtilizationPercentage: 80
    service:
      type: ClusterIP
      port: 80
    # Disable internal DB/Redis for external setup
    mariadb.enabled: false
    postgresql.enabled: false
    redis:
      enabled: true  # Enables Redis for caching/locking to improve performance
      auth:
        enabled: false  # Disable password if not needed
      master:
        persistence:
          enabled: true
          storageClass: nfs-csi  # Or openebs-hostpath for faster local caching
          size: 1Gi
    # Enhanced probes for large file handling
    livenessProbe:
      initialDelaySeconds: 120
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 3
    readinessProbe:
      initialDelaySeconds: 60
      periodSeconds: 20
      timeoutSeconds: 5
      failureThreshold: 3
    # Security hardening
    securityContext:
      runAsUser: 33
      runAsGroup: 33
      runAsNonRoot: true
      readOnlyRootFilesystem: true  # Mount /tmp as tmpfs for writes
      capabilities:
        drop: ["ALL"]
    # Monitoring
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
    # Optional: App-level backups (daily to complement DB backups)
    # cronjob:
    #   createBackupJob:
    #     enabled: true
    #     schedule: "0 2 * * *"